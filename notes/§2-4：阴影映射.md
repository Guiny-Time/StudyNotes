---
tags: [TA/Unity Shader]
title: §2-4：阴影映射
created: '2022-10-18T08:17:21.895Z'
modified: '2022-10-18T12:14:31.258Z'
---

# §2-4：阴影映射
阴影映射(Shadow Mapping)是一种计算阴影的技术。阴影映射的关键思想是：当一个点不在阴影里时，它一定可以被相机和光源同时看见。对此，我们的做法是:
1. 记录从**光源**出发的**深度图**(这便是**Shadow Map**)
2. 从相机处观察每个点，将其通过矩阵换算回光源坐标系
3. 找到对应像素上该点的深度，如果深度与点的深度一致，则光源能够看到该点
4. 如果深度不一致，说明该点被遮挡，此处为阴影

由于浮点数精度问题（即使高精度也难以避免），得到的结果可能会很“赃”，如下图所示：
<img src="https://tvax2.sinaimg.cn/large/006UcwnJly1h79oo2d563j30d50am0v5.jpg" alt="image" width="273" data-width="473" data-height="382">

所以，原本“如果相等则能看到”的方法要稍微改一改，例如改成：**如果该点的深度大于光源深度图的值，则该点位于阴影中，其余不在阴影中**即可，省去判定相等的步骤，改成比大小。然而，由于一些值还是非常接近，所以精度问题本质上难以避免。

## 阴影图的问题
- 分辨率问题
我们把光源出发记录的深度图叫成阴影图（Shadow Map），这张图实际上是有分辨率的。还记得打开Unity导入一个3D模型，它的阴影糊的像一坨马赛克吗？

<img src="https://tva2.sinaimg.cn/large/006UcwnJly1h79ow9a9zxj30dm09itay.jpg" alt="image" width="390" data-width="490" data-height="342">

这是阴影图分辨率不够造成的，可以在设置里修改其分辨率大小与屏幕分辨率一致，但无疑会增加开销。
- 硬阴影
阴影图只能处理硬阴影，而无法实现逼近真实效果的软阴影：
<img src="https://tva1.sinaimg.cn/large/006UcwnJly1h79p4metqsj30av0hrgn4.jpg" alt="image" width="291" data-width="391" data-height="639">

软阴影其实是半影，硬阴影是本影。嗯...可以看一下日食示意图，其中日全食表示本影遮挡，日偏食在半影区。目前来讲，想做出这种效果，需要依赖光线追踪。
